<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Useful App</title>
</head>
<body>
<h1>Useful App</h1>
<div th:if="${alert != null}" th:text="${alert}"></div>
<p>You are not logged in</p>
<ul>
    <li>
        <form method="POST" action="/login-mail">
            <label for="email">Login with email:</label>
            <input type="text" name="email" id="email" placeholder="user@example.com"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit">Log In</button>
        </form>
    </li>
    <li>
        <button id="login-webauthn">Login with Passkey</button>
    </li>
</ul>
<h2>No account yet?</h2>
<a href="/user/register">Sign up</a>

</body>
<script th:inline="javascript">
    const credentialsRequestOptions = {
        publicKey: {
            challenge: Uint8Array.from([[${challenge}]], c => c.charCodeAt(0)),
            // TODO: clarify
            rpId: "localhost"
        }
    };

    document.getElementById("login-webauthn").addEventListener("click", async () => {
        const credentialsResponse = await navigator.credentials.get(credentialsRequestOptions);
        fetch("/passkey/login",
            {
                method: "POST",
                body: JSON.stringify(credentialsResponse),
                credentials: "same-origin",
                headers: {
                    [[${_csrf.headerName}]]: [[${_csrf.token}]],
                    "Content-Type": "application/json;charset=utf-8"
                },
                redirect: "follow"
            })
            // TODO: this is a hack, we should be using a form instead
            // Or a REST response with a Link: header
            .then(r => window.location.href = r.url)
            .catch(err => console.error(err))
            .finally(() => console.log("yep, done"));
        console.log(credentialsResponse);
        console.log(JSON.stringify(credentialsResponse));
    });
    // "allowCredentials": [
    // {
    //     "type": "public-key",
    //     "id": "a_TJPMGXaqyff0ZuEVD3k3bnfiiK049rPnmWSfnNkIFW1vWYaKSgIJpIiuyUChF0Br7MDUxpbKRKVWtGKQv1tA"
    // }
    // ],
    //     "userVerification": "preferred",
    //     "extensions": {
    //     "appid": "https://localhost:8443"
    // }
</script>
</html>